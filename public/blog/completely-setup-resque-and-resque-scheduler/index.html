<!doctype html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>
            
                Completely setup Resque &#43; Resque Schedule and Resque Mailer - Khoa Pham
            
        </title>

        <meta name="keywords" content="Khoa Pham, web developer, frontend developer, UX, UI, web developer Portland " >
<meta name="description" content="Khoa Pham is a senior developer focusing on UX and writing clean code using latest technologies like Golang, Rails, EmberJS, and Postgres "/>
<meta name="viewport" content="width=device-width initial-scale=1.0" />
<link rel="canonical" href="http://khoapham.me" />
<link rel="author" href="https://plus.google.com/103713398374675106375/"/>


<meta property="og:title" content="Khoa Pham" >
<meta property="og:site_name" content="Khoa Pham - Web Developer">
<meta property="og:url" content="http://khoapham.me" >
<meta property="og:description" content="Khoa Pham is a senior developer focusing on UX and writing clean code using latest technologies like Golang, Rails, EmberJS, and Postgres" >
<meta property="og:image" content="https://avatars0.githubusercontent.com/u/1144585" >
<meta property="og:type" content="website" >
<meta property="og:locale" content="en_US" >

<meta property="twitter:card" content="summary" >
<meta property="twitter:title" content="Khoa Pham - Web Developer" >
<meta property="twitter:description" content="Khoa Pham is a senior developer focusing on UX and writing clean code using latest technologies like Golang, Rails, EmberJS, and Postgres" >
<meta property="twitter:creator" content="@pmkhoa" >
<meta property="twitter:url" content="http://khoapham.me" >
<meta property="twitter:image" content="https://avatars0.githubusercontent.com/u/1144585 " >




        
        <link rel="shortcut icon" href="http://khoapham.me/img/favicon.ico">

        
        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://khoapham.me/index.xml">

        <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://khoapham.me/css/all.css">
        <link rel="stylesheet" href="http://khoapham.me/css/custom.css">
    </head>
    <body lang="en">
        <nav class="header" role="banner">
            <div class="inner-header wrap clearfix">
                <a id="logo" href="http://khoapham.me/">KHOA&nbsp;&nbsp;PHAM</a>
                <ul class="header-nav">
                    <li class="nav-item"><a href="http://khoapham.me/blog" title="Blog">Blog</a></li>
                    <li class="nav-item"><a href="http://khoapham.me/about" title="About">About</a></li>
                </ul>
            </div>
        </nav>

<div class="Article-wrapper">
    <div class="Article-container">
        <div class="Article-content wrap clearfix">
            <h1 class="Article-title">Completely setup Resque &#43; Resque Schedule and Resque Mailer</h1>
            <p>When developing Rails app, there will be a chance that you will need to setup
job scheduler using Resque. In this post, I&rsquo;d like to share my experience
setting up Resque schedule, and resque mailer on my recent Rails application
 <a href="https://my.onesight.org/en">My OneSight</a>.</p>

<p>In your Gemfile, add these gems:</p>

<pre><code>gem 'resque', :require =&gt; &quot;resque/server&quot;
gem 'resque_mailer'
gem 'resque-scheduler', :require =&gt; 'resque/scheduler/server’
</code></pre>

<p>Create config/resque.yml, to store redis environment.</p>

<pre><code>defaults: &amp;defaults
  host: localhost
  port: 6379
  db: 6
development:
  &lt;&lt;: *defaults
test:
  &lt;&lt;: *defaults
staging:
  &lt;&lt;: *defaults
production:
  &lt;&lt;: *defaults
</code></pre>

<p>Create config/initializers/resque.rb to bootstrap your resque:</p>

<pre><code>require 'resque/failure/multiple'
require 'resque/failure/redis'
Resque::Failure::Multiple.classes = [Resque::Failure::Redis]
Resque::Failure.backend = Resque::Failure::Multiple
Dir[File.join(Rails.root, 'app', 'jobs', '*.rb')].each { |file| require file }
config = YAML.load(File.open(&quot;#{Rails.root}/config/resque.yml&quot;))[Rails.env]
Resque.redis = Redis.new(host: config['host'], port: config['port'], db: config['db'])
</code></pre>

<p>Create AsyncMailer to send mail via resque mailer</p>

<pre><code>class AsyncMailer &lt; ActionMailer::Base
  include Resque::Mailer
end
</code></pre>

<p>Then, replace all current ActionMailer, to AsyncMailer. Ex: mailers/communication_mailer.rb</p>

<pre><code>class CommunicationMailer&lt; AsyncMailer
  ...
end
</code></pre>

<p>Create rake task for resque setup: /lib/tasks/resque.rake , and create resque-scheduler</p>

<pre><code>require &quot;resque/tasks&quot;
require 'resque/scheduler/tasks'

task &quot;resque:setup&quot; =&gt; :environment do
  require 'resque'
  require 'resque-scheduler'
  Resque.schedule = YAML.load_file(Rails.root.join 'config', 'resque_schedule.yml')
end
</code></pre>

<p>Create a resque scheduler jobs /config/resque_schedule.yml:</p>

<pre><code>complete_profile_reminder:
  every: 30s
  class: MyJob
  queue: user_notifications
  args:
  description: Runs the perform method in MyJob
</code></pre>

<p>The MyJob class is defined under: /app/controllers/jobs</p>

<pre><code>class MyJob
  def self.perform
    # Do anything here
    puts &quot;Email user to complete their profile&quot;
  end
end
</code></pre>

<p>Route resque-web interface inside Rails.
Since we already required &ldquo;resque/server”, and &lsquo;resque/scheduler/server’, in our Gemfile. We can just route the resque inside our routes.rb</p>

<pre><code>mount Resque::Server.new =&gt; '/resque’
</code></pre>

<p>Bonus: Setup Procfile to use foreman to start rails server and resque. Create your Procfile as follow:</p>

<pre><code>web: bundle exec unicorn -p $PORT -c ./config/unicorn.rb
redis: redis-server
worker: env TERM_CHILD=1 QUEUES=* bundle exec rake resque:work
scheduler: bundle exec rake resque:scheduler
</code></pre>

<hr />

<p><strong>Resources</strong></p>

<ol>
<li><a href="https://github.com/resque/resque">Resque</a></li>
<li><a href="https://github.com/resque/resque-scheduler">Resque Scheduler</a></li>
<li><a href="https://github.com/zapnap/resque_mailer">Resque Mailer</a></li>
</ol>

        </div>
        
        
        <div class="Article-related">
            <div class="Article-related-content wrap clearfix">
                <div class="Article-related-title">
                    <h3 class="uppercase"><span class="icon-shuffle"></span>More Articles</h3>
                </div>
                
                
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                        <a href="http://khoapham.me/blog/tower-of-hanoi/" class="link-to-article">
    <div class="Article-summary">
        <h3>Tower of Hanoi</h3>
        <p>One of my favorite childhood game was the Tower of Hanoi which I loved playing it with my neighbor friends all the time. Also, one of my very first project in college was implementing the tower of Hanoi in C, C++, or Java. I guess this game has sticked with me for a very long time, so that today I decided to implement it again in my new favorite language - Ruby.</p>
    </div>
</a>

                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                        <a href="http://khoapham.me/blog/deploy-middleman-to-heroku/" class="link-to-article">
    <div class="Article-summary">
        <h3>Deploy Middleman to Heroku</h3>
        <p><p>Heroku is a great cloud service, it uses git for version control and deployment which is very handy for me to just update my blog in one command.
Here are some simple step that you can set it up.</p>
</p>
    </div>
</a>

                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
                    
                    
                    
                
            </div>
        </div>
        
    </div>
</div>
    <footer>
    <p class="footer-copyright">Carefully crafted by <a href="http://khoapham.me/about">Khoa Pham</a></p>
    </footer>

        <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41349606-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad(); 
    </script>
  </body>
</html>

